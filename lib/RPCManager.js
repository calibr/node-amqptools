var async = require("async");
var randomString = require("just.randomstring");
var ChannelManager_1 = require('./ChannelManager');
var QUEUE_PREFIX = "_queue_rpc:";
var CALL_TIMEOUT = 3600 * 1000;
var returnCbs = {}, replyQueue = "", DEBUG = false;
function dbg() {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i - 0] = arguments[_i];
    }
    if (DEBUG) {
        console.log.apply(console, args);
    }
}
setInterval(function () {
    var removeKeys = [], now = new Date().getTime(), k, timeCreated, data;
    for (k in returnCbs) {
        timeCreated = returnCbs[k].date.getTime();
        if (now - timeCreated >= CALL_TIMEOUT) {
            removeKeys.push(k);
        }
    }
    removeKeys.forEach(function (k) {
        data = returnCbs[k];
        delete returnCbs[k];
    });
}, 3600 * 1000);
function _parseAction(event) {
    return {
        queue: QUEUE_PREFIX + event,
    };
}
function _errorPrepare(err) {
    if (!err) {
        return null;
    }
    return {
        code: err.code ? err.code : -1,
        msg: err.message,
        data: err.data,
        errtype: err.errtype
    };
}
var RPC = (function () {
    function RPC() {
        this.processors = {};
    }
    RPC.prototype.createQueue = function (action, cb) {
        var _this = this;
        return ChannelManager_1.channelManager.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                var actionParsed = _parseAction(action);
                channel.assertQueue(actionParsed.queue, {}, function (err, attrs) {
                    if (err)
                        return reject(err);
                    channel.consume(actionParsed.queue, function (msg) {
                        var content = JSON.parse(msg.content.toString());
                        try {
                            dbg("Incoming RPC request", action);
                            _this.processors[action].listener(content, function (err, body) {
                                var response = {
                                    error: _errorPrepare(err),
                                    body: typeof body !== "undefined" ? body : null
                                };
                                channel.sendToQueue(msg.properties.replyTo, new Buffer(JSON.stringify(response)), {
                                    correlationId: msg.properties.correlationId
                                });
                                dbg("Incoming RPC request", action, " processed! reply to", msg.properties.replyTo);
                            });
                        }
                        catch (ex) {
                            console.error("ERROR IN rpc processor\n", ex.message, ex.stack);
                        }
                        channel.ack(msg);
                    }, {}, function (err, res) {
                        if (err)
                            return reject(err);
                        resolve(res.consumerTag);
                    });
                });
            });
        }).nodeify(cb);
    };
    ;
    RPC.prototype.register = function (action, cb, registerCb) {
        var _this = this;
        registerCb = registerCb || (function () { return null; });
        if (this.processors[action]) {
            throw new Error("Can't register same action processor twice");
        }
        var consumerTag;
        async.series([
            function (next) {
                ChannelManager_1.channelManager.connect(function () {
                    next();
                });
            },
            function (next) {
                _this.createQueue(action, function (err, tag) {
                    if (!err) {
                        consumerTag = tag;
                    }
                    next(err);
                });
            }
        ], function (err) {
            if (!err) {
                _this.processors[action] = {
                    listener: cb,
                    consumerTag: consumerTag
                };
            }
            registerCb(err);
        });
        return true;
    };
    ;
    RPC.prototype.unregister = function (action, cb) {
        var _this = this;
        return ChannelManager_1.channelManager.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                if (!_this.processors[action]) {
                    process.nextTick(function () { return resolve(null); });
                    return;
                }
                channel.cancel(_this.processors[action].consumerTag, function (err) {
                    if (err)
                        return reject(err);
                    delete _this.processors[action];
                    resolve(null);
                });
            });
        }).nodeify(cb);
    };
    ;
    RPC.prototype.call = function (action, params, cb) {
        return ChannelManager_1.channelManager.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                if (typeof params === "function") {
                    cb = params;
                    params = {};
                }
                var actionParsed = _parseAction(action);
                async.series([
                    function (next) {
                        ChannelManager_1.channelManager.connect(function () {
                            next();
                        });
                    },
                    function (next) {
                        if (replyQueue) {
                            return next();
                        }
                        channel.assertQueue("", {
                            durable: false,
                            autoDelete: true
                        }, function (err, attrs) {
                            if (err)
                                return reject(err);
                            replyQueue = attrs.queue;
                            channel.consume(replyQueue, function (_msg) {
                                var msg = JSON.parse(_msg.content.toString()), correlationId = _msg.properties.correlationId;
                                if (returnCbs[correlationId]) {
                                    dbg("RPC Response", returnCbs[correlationId].action);
                                    var resError = null;
                                    if (msg.error) {
                                        resError = new Error(msg.error.msg);
                                        resError.code = msg.error.code;
                                        resError.errtype = msg.error.errtype;
                                        resError.data = msg.error.data;
                                    }
                                    var returnCb = returnCbs[correlationId].cb;
                                    delete returnCbs[correlationId];
                                    returnCb(resError, msg.body);
                                }
                                else {
                                    dbg("Obtained reply but unrecognized by correlationId:", correlationId);
                                }
                                channel.ack(_msg);
                            });
                            next();
                        });
                    },
                    function () {
                        var correlationId = randomString(48);
                        dbg("RPC Call", action, "wait reply to", replyQueue);
                        returnCbs[correlationId] = {
                            date: new Date(),
                            cb: cb,
                            action: action,
                            params: params
                        };
                        channel.sendToQueue(actionParsed.queue, new Buffer(JSON.stringify(params)), {
                            correlationId: correlationId,
                            replyTo: replyQueue
                        });
                    }
                ]);
            });
        }).nodeify(cb);
    };
    RPC.purgeActionQueue = function (action, cb) {
        return ChannelManager_1.channelManager.getChannel().then(function (channel) {
            var actionParsed = _parseAction(action);
            channel.purgeQueue(actionParsed.queue, cb);
        });
    };
    ;
    return RPC;
})();
module.exports = RPC;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUlBDTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9SUENNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbImRiZyIsIl9wYXJzZUFjdGlvbiIsIl9lcnJvclByZXBhcmUiLCJSUEMiLCJSUEMuY29uc3RydWN0b3IiLCJSUEMuY3JlYXRlUXVldWUiLCJSUEMucmVnaXN0ZXIiLCJSUEMudW5yZWdpc3RlciIsIlJQQy5jYWxsIiwiUlBDLnB1cmdlQWN0aW9uUXVldWUiXSwibWFwcGluZ3MiOiJBQUNBLElBQU8sS0FBSyxXQUFXLE9BQU8sQ0FBQyxDQUFBO0FBRS9CLElBQU8sWUFBWSxXQUFXLG1CQUFtQixDQUFDLENBQUE7QUFDbEQsK0JBQStCLGtCQUUvQixDQUFDLENBRmdEO0FBRWpELElBQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQztBQUNuQyxJQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBRWpDLElBQUksU0FBUyxHQUFHLEVBQUUsRUFDaEIsVUFBVSxHQUFHLEVBQUUsRUFDZixLQUFLLEdBQUcsS0FBSyxDQUFDO0FBRWhCO0lBQWFBLGNBQWFBO1NBQWJBLFdBQWFBLENBQWJBLHNCQUFhQSxDQUFiQSxJQUFhQTtRQUFiQSw2QkFBYUE7O0lBQ3hCQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNWQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUNuQ0EsQ0FBQ0E7QUFDSEEsQ0FBQ0E7QUFFRCxXQUFXLENBQUM7SUFFVixJQUFJLFVBQVUsR0FBRyxFQUFFLEVBQ2pCLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUMxQixDQUFDLEVBQ0QsV0FBVyxFQUNYLElBQUksQ0FBQztJQUNQLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLFdBQVcs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