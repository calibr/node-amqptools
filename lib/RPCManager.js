/// <reference path="../typings/tsd.d.ts" />
var async = require("async");
var randomString = require("just.randomstring");
var QUEUE_PREFIX = "_queue_rpc:";
var CALL_TIMEOUT = 3600 * 1000;
var returnCbs = {}, replyQueue = "", DEBUG = false;
function dbg() {
    var args = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        args[_i - 0] = arguments[_i];
    }
    if (DEBUG) {
        console.log.apply(console, args);
    }
}
setInterval(function () {
    var removeKeys = [], now = new Date().getTime(), k, timeCreated, data;
    for (k in returnCbs) {
        timeCreated = returnCbs[k].date.getTime();
        if (now - timeCreated >= CALL_TIMEOUT) {
            removeKeys.push(k);
        }
    }
    removeKeys.forEach(function (k) {
        data = returnCbs[k];
        delete returnCbs[k];
    });
}, 3600 * 1000);
function _parseAction(event) {
    return {
        queue: QUEUE_PREFIX + event,
    };
}
function _errorPrepare(err) {
    if (!err) {
        return null;
    }
    return {
        code: err.code ? err.code : -1,
        msg: err.message,
        data: err.data,
        errtype: err.errtype
    };
}
var RPC = (function () {
    function RPC() {
        this.processors = {};
    }
    RPC.getChannel = function () {
        return RPC.channelManager.getChannel();
    };
    RPC.prototype.createQueue = function (action, cb) {
        var _this = this;
        return RPC.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                var actionParsed = _parseAction(action);
                channel.assertQueue(actionParsed.queue, {}, function (err, attrs) {
                    if (err)
                        return reject(err);
                    channel.consume(actionParsed.queue, function (msg) {
                        var content = JSON.parse(msg.content.toString());
                        try {
                            dbg("Incoming RPC request", action);
                            _this.processors[action].listener(content, function (err, body) {
                                var response = {
                                    error: _errorPrepare(err),
                                    body: typeof body !== "undefined" ? body : null
                                };
                                channel.sendToQueue(msg.properties.replyTo, new Buffer(JSON.stringify(response)), {
                                    correlationId: msg.properties.correlationId
                                });
                                dbg("Incoming RPC request", action, " processed! reply to", msg.properties.replyTo);
                            });
                        }
                        catch (ex) {
                            console.error("ERROR IN rpc processor\n", ex.message, ex.stack);
                        }
                        channel.ack(msg);
                    }, {}, function (err, res) {
                        if (err)
                            return reject(err);
                        resolve(res.consumerTag);
                    });
                });
            });
        }).nodeify(cb);
    };
    ;
    RPC.prototype.register = function (action, cb, registerCb) {
        var _this = this;
        registerCb = registerCb || (function () { return null; });
        if (this.processors[action]) {
            throw new Error("Can't register same action processor twice");
        }
        var consumerTag;
        async.series([
            function (next) {
                RPC.channelManager.connect(function () {
                    next();
                });
            },
            function (next) {
                _this.createQueue(action, function (err, tag) {
                    if (!err) {
                        consumerTag = tag;
                    }
                    next(err);
                });
            }
        ], function (err) {
            if (!err) {
                _this.processors[action] = {
                    listener: cb,
                    consumerTag: consumerTag
                };
            }
            registerCb(err);
        });
        return true;
    };
    ;
    RPC.prototype.unregister = function (action, cb) {
        var _this = this;
        return RPC.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                if (!_this.processors[action]) {
                    process.nextTick(function () { return resolve(null); });
                    return;
                }
                channel.cancel(_this.processors[action].consumerTag, function (err) {
                    if (err)
                        return reject(err);
                    delete _this.processors[action];
                    resolve(null);
                });
            });
        }).nodeify(cb);
    };
    ;
    RPC.prototype.call = function (action, params, cb) {
        return RPC.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                if (typeof params === "function") {
                    cb = params;
                    params = {};
                }
                var actionParsed = _parseAction(action);
                async.series([
                    function (next) {
                        RPC.channelManager.connect(function () {
                            next();
                        });
                    },
                    function (next) {
                        if (replyQueue) {
                            return next();
                        }
                        channel.assertQueue("", {
                            durable: false,
                            autoDelete: true
                        }, function (err, attrs) {
                            if (err)
                                return reject(err);
                            replyQueue = attrs.queue;
                            channel.consume(replyQueue, function (_msg) {
                                var msg = JSON.parse(_msg.content.toString()), correlationId = _msg.properties.correlationId;
                                if (returnCbs[correlationId]) {
                                    dbg("RPC Response", returnCbs[correlationId].action);
                                    var resError = null;
                                    if (msg.error) {
                                        resError = new Error(msg.error.msg);
                                        resError.code = msg.error.code;
                                        resError.errtype = msg.error.errtype;
                                        resError.data = msg.error.data;
                                    }
                                    var returnCb = returnCbs[correlationId].cb;
                                    delete returnCbs[correlationId];
                                    returnCb(resError, msg.body);
                                }
                                else {
                                    dbg("Obtained reply but unrecognized by correlationId:", correlationId);
                                }
                                channel.ack(_msg);
                            });
                            next();
                        });
                    },
                    function () {
                        var correlationId = randomString(48);
                        dbg("RPC Call", action, "wait reply to", replyQueue);
                        returnCbs[correlationId] = {
                            date: new Date(),
                            cb: cb,
                            action: action,
                            params: params
                        };
                        channel.sendToQueue(actionParsed.queue, new Buffer(JSON.stringify(params)), {
                            correlationId: correlationId,
                            replyTo: replyQueue
                        });
                    }
                ]);
            });
        }).nodeify(cb);
    };
    RPC.purgeActionQueue = function (action, cb) {
        return RPC.getChannel().then(function (channel) {
            var actionParsed = _parseAction(action);
            channel.purgeQueue(actionParsed.queue, cb);
        });
    };
    ;
    return RPC;
})();
module.exports = RPC;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUlBDTWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9SUENNYW5hZ2VyLnRzIl0sIm5hbWVzIjpbImRiZyIsIl9wYXJzZUFjdGlvbiIsIl9lcnJvclByZXBhcmUiLCJSUEMiLCJSUEMuY29uc3RydWN0b3IiLCJSUEMuZ2V0Q2hhbm5lbCIsIlJQQy5jcmVhdGVRdWV1ZSIsIlJQQy5yZWdpc3RlciIsIlJQQy51bnJlZ2lzdGVyIiwiUlBDLmNhbGwiLCJSUEMucHVyZ2VBY3Rpb25RdWV1ZSJdLCJtYXBwaW5ncyI6IkFBQUEsNENBQTRDO0FBRzVDLElBQU8sS0FBSyxXQUFXLE9BQU8sQ0FBQyxDQUFBO0FBRS9CLElBQU8sWUFBWSxXQUFXLG1CQUFtQixDQUFDLENBQUE7QUFHbEQsSUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDO0FBQ25DLElBQU0sWUFBWSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFFakMsSUFBSSxTQUFTLEdBQUcsRUFBRSxFQUNoQixVQUFVLEdBQUcsRUFBRSxFQUNmLEtBQUssR0FBRyxLQUFLLENBQUM7QUFFaEI7SUFBYUEsY0FBYUE7U0FBYkEsV0FBYUEsQ0FBYkEsc0JBQWFBLENBQWJBLElBQWFBO1FBQWJBLDZCQUFhQTs7SUFDeEJBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO1FBQ1ZBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBQ25DQSxDQUFDQTtBQUNIQSxDQUFDQTtBQUVELFdBQVcsQ0FBQztJQUVWLElBQUksVUFBVSxHQUFHLEVBQUUsRUFDakIsR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQzFCLENBQUMsRUFDRCxXQUFXLEVBQ1gsSUFBSSxDQUFDO0lBQ1AsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDcEIsV0FBVyxH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