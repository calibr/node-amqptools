/// <reference path="../typings/tsd.d.ts" />
var events = require("events");
var util = require("util");
var async = require("async");
var EXCHANGE_PREFIX = "_event:";
var QUEUE_PREFIX = "_queue:";
var EventEmitter = events.EventEmitter, addListenerMethods = ["addListener", "on", "once"], copyMethods = ["removeListener", "removeAllListeners", "setMaxListeners", "listeners"];
var channel = null;
function parseEvent(event) {
    var tmp = event.split(":");
    return {
        exchange: EXCHANGE_PREFIX + ":" + tmp[0],
        topic: tmp[1]
    };
}
function _getChannel(cb) {
    cb(null, channel);
}
var AMQPEventEmitter = (function () {
    function AMQPEventEmitter(runtime) {
        var _this = this;
        this.runtime = runtime || "";
        this.ee = new EventEmitter();
        this.eventsQueues = {};
        addListenerMethods.forEach(function (method) {
            _this[method] = function (event, cb, eventSetCb) {
                if (["newListener", "removeListener"].indexOf(event) !== -1) {
                    return _this.ee[method].call(_this.ee, event, cb);
                }
                _this.preListen(event, function (err) {
                    if (!err) {
                        _this.ee[method].call(_this.ee, event, cb);
                    }
                    if (eventSetCb) {
                        eventSetCb(err);
                    }
                });
            };
        });
        copyMethods.forEach(function (method) {
            _this[method] = function () {
                var args = [];
                for (var _i = 0; _i < arguments.length; _i++) {
                    args[_i - 0] = arguments[_i];
                }
                _this.ee[method].apply(_this.ee, args);
            };
        });
    }
    AMQPEventEmitter._connect = function (cb) {
        throw new Error('Need to set tasks connect function');
    };
    AMQPEventEmitter.prototype.preListen = function (event, cb) {
        var _this = this;
        AMQPEventEmitter._connect(function () {
            var eParsed = parseEvent(event);
            _this.assertExchange(eParsed.exchange, function (err) {
                if (err)
                    return cb(err);
                async.series([
                    function (next) {
                        if (_this.eventsQueues[event]) {
                            return next();
                        }
                        _this.createQueue(event, function (err) {
                            if (err)
                                return cb(err);
                            next();
                        });
                    },
                    function () { return cb(null); }
                ]);
            });
        });
    };
    ;
    AMQPEventEmitter.prototype.createQueue = function (event, cb) {
        var _this = this;
        var eParsed = parseEvent(event);
        _getChannel(function (err, chan) {
            if (err)
                return cb(err);
            var queueName = QUEUE_PREFIX + _this.runtime + ":" + eParsed.exchange;
            if (eParsed.topic) {
                queueName += ":" + eParsed.topic;
            }
            chan.assertQueue(queueName, {
                durable: false,
                autoDelete: true
            }, function (err, attrs) {
                if (err)
                    return cb(err);
                chan.bindQueue(queueName, eParsed.exchange, eParsed.topic, {}, function (err) {
                    if (err)
                        return cb(err);
                    _this.eventsQueues[event] = queueName;
                    chan.consume(queueName, function (msg) {
                        var content = JSON.parse(msg.content.toString()), args = util.isArray(content) ? [event].concat(content) : [event, content];
                        chan.ack(msg);
                        _this.ee.emit.apply(_this.ee, args);
                    });
                    cb(null);
                });
            });
        });
    };
    ;
    AMQPEventEmitter.prototype.assertExchange = function (name, cb) {
        _getChannel(function (err, chan) {
            if (err)
                return cb(err);
            chan.assertExchange(name, "direct", {
                durable: false,
                autoDelete: true
            }, function (err) { return cb(err); });
        });
    };
    ;
    AMQPEventEmitter.prototype.emit = function (event) {
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        var eParsed = parseEvent(event);
        this.preListen(event, function (err) {
            if (!err) {
                _getChannel(function (err, chan) {
                    if (err)
                        return;
                    var buffer = new Buffer(JSON.stringify(args));
                    chan.publish(eParsed.exchange, eParsed.topic, buffer, {
                        contentType: "text/json"
                    });
                });
            }
        });
    };
    ;
    AMQPEventEmitter.setChannel = function (_channel) {
        channel = _channel;
    };
    ;
    return AMQPEventEmitter;
})();
module.exports = AMQPEventEmitter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnRFbWl0dGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2V2ZW50RW1pdHRlci50cyJdLCJuYW1lcyI6WyJwYXJzZUV2ZW50IiwiX2dldENoYW5uZWwiLCJBTVFQRXZlbnRFbWl0dGVyIiwiQU1RUEV2ZW50RW1pdHRlci5jb25zdHJ1Y3RvciIsIkFNUVBFdmVudEVtaXR0ZXIuX2Nvbm5lY3QiLCJBTVFQRXZlbnRFbWl0dGVyLnByZUxpc3RlbiIsIkFNUVBFdmVudEVtaXR0ZXIuY3JlYXRlUXVldWUiLCJBTVFQRXZlbnRFbWl0dGVyLmFzc2VydEV4Y2hhbmdlIiwiQU1RUEV2ZW50RW1pdHRlci5lbWl0IiwiQU1RUEV2ZW50RW1pdHRlci5zZXRDaGFubmVsIl0sIm1hcHBpbmdzIjoiQUFBQSw0Q0FBNEM7QUFFNUMsSUFBTyxNQUFNLFdBQVcsUUFBUSxDQUFDLENBQUE7QUFDakMsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUE7QUFDN0IsSUFBTyxLQUFLLFdBQVcsT0FBTyxDQUFDLENBQUE7QUFFL0IsSUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDO0FBQ2xDLElBQU0sWUFBWSxHQUFHLFNBQVMsQ0FBQztBQUUvQixJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsWUFBWSxFQUNwQyxrQkFBa0IsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQ2xELFdBQVcsR0FBRyxDQUFDLGdCQUFnQixFQUFFLG9CQUFvQixFQUFFLGlCQUFpQixFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBRXpGLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztBQUVuQixvQkFBb0IsS0FBSztJQUN2QkEsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDM0JBLE1BQU1BLENBQUNBO1FBQ0xBLFFBQVFBLEVBQUVBLGVBQWVBLEdBQUdBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLENB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Q0FBQ0E7WUFDckVBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO2dCQUNsQkEsU0FBU0EsSUFBSUEsR0FBR0EsR0FBR0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDbkNBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFNBQVNBLEVBQUVBO2dCQUMxQkEsT0FBT0EsRUFBRUEsS0FBS0E7Z0JBQ2RBLFVBQVVBLEVBQUVBLElBQUlBO2FBQ2pCQSxFQUFFQSxVQUFDQSxHQUFHQSxFQUFFQSxLQUFLQTtnQkFDWkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0E7b0JBQUNBLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO2dCQUV4QkEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsU0FBU0EsRUFBRUEsT0FBT0EsQ0FBQ0EsUUFBUUEsRUFBRUEsT0FBT0EsQ0FBQ0EsS0FBS0EsRUFBRUEsRUFBRUEsRUFBRUEsVUFBQ0EsR0FBR0E7b0JBQ2pFQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQTt3QkFBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBRXhCQSxLQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxTQUFTQSxDQUFDQTtvQkFDckNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLEVBQUVBLFVBQUNBLEdBQUdBO3dCQUMxQkEsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsRUFDOUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO3dCQUU1RUEsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7d0JBQ2RBLEtBQUlBLENBQUNBLEVBQUVBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEtBQUlBLENBQUNBLEVBQUVBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO29CQUNwQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ0hBLEVBQUVBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNYQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNMQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNMQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNMQSxDQUFDQTs7SUFFT0oseUNBQWNBLEdBQXRCQSxVQUF1QkEsSUFBSUEsRUFBRUEsRUFBRUE7UUFDN0JLLFdBQVdBLENBQUNBLFVBQUNBLEdBQUdBLEVBQUVBLElBQUlBO1lBQ3BCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQTtnQkFBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFFeEJBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLEVBQUVBO2dCQUNsQ0EsT0FBT0EsRUFBRUEsS0FBS0E7Z0JBQ2RBLFVBQVVBLEVBQUVBLElBQUlBO2FBQ2pCQSxFQUFFQSxVQUFDQSxHQUFHQSxJQUFLQSxPQUFBQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFQQSxDQUFPQSxDQUFDQSxDQUFDQTtRQUN2QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7O0lBRURMLCtCQUFJQSxHQUFKQSxVQUFLQSxLQUFLQTtRQUFFTSxjQUFhQTthQUFiQSxXQUFhQSxDQUFiQSxzQkFBYUEsQ0FBYkEsSUFBYUE7WUFBYkEsNkJBQWFBOztRQUN2QkEsSUFBSUEsT0FBT0EsR0FBR0EsVUFBVUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDaENBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLEVBQUVBLFVBQUNBLEdBQUdBO1lBQ3hCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDVEEsV0FBV0EsQ0FBQ0EsVUFBQ0EsR0FBR0EsRUFBRUEsSUFBSUE7b0JBQ3BCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQTt3QkFBQ0EsTUFBTUEsQ0FBQ0E7b0JBQ2hCQSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFFOUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLEVBQUVBLE9BQU9BLENBQUNBLEtBQUtBLEVBQUVBLE1BQU1BLEVBQUVBO3dCQUNwREEsV0FBV0EsRUFBRUEsV0FBV0E7cUJBQ3pCQSxDQUFDQSxDQUFDQTtnQkFDTEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDTEEsQ0FBQ0E7UUFDSEEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7O0lBRU1OLDJCQUFVQSxHQUFqQkEsVUFBa0JBLFFBQVFBO1FBQ3hCTyxPQUFPQSxHQUFHQSxRQUFRQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7O0lBQ0hQLHVCQUFDQTtBQUFEQSxDQUFDQSxBQXpIRCxJQXlIQztBQUVELGlCQUFTLGdCQUFnQixDQUFDIn0=