/// <reference path="../typings/tsd.d.ts" />
var TaskManager = require("./");
var EXCHANGE_PREFIX = "nimbus:jobs:";
var QUEUE_PREFIX = "nimbus:jobs:queue:";
var EXCHANGE_OPTIONS = { durable: true, autoDelete: false };
var JOB_QUEUE_OPTIONS = { durable: true, autoDelete: false };
var Promise = require("bluebird");
var uuid = require("node-uuid");
var _ = require("lodash");
var queues = {};
var Task = (function () {
    function Task(type, params) {
        this.uuid = uuid.v4();
        this.type = type;
        this.params = params;
    }
    Task.prototype.getChannel = function () {
        return this.taskManager.getChannel();
    };
    Task.prototype.start = function (done) {
        var _this = this;
        var currentChannel;
        var params = _.clone(this.params);
        params['uuid'] = this.uuid;
        var eventData = new Buffer(JSON.stringify(params));
        this.getChannel().then(function (channel) {
            currentChannel = channel;
            return _this.taskManager.assertExchange();
        }).then(function () {
            return _this.taskManager.getQueue(_this.type, true);
        }).then(function () {
            currentChannel.publish(_this.taskManager.exchangeName, _this.type, eventData);
            if (done)
                done();
        });
        return this;
    };
    return Task;
})();
var TaskManager = (function () {
    function TaskManager() {
        this.service = "unknown";
        this.exchangeName = "";
    }
    TaskManager.prototype.createTask = function (type, params) {
        var task = new Task(type, params);
        task.taskManager = this;
        return task;
    };
    TaskManager.prototype.getChannel = function () {
        return TaskManager.channelManager.getChannel();
    };
    Object.defineProperty(TaskManager.prototype, "channelManager", {
        set: function (value) {
            TaskManager.channelManager = value;
        },
        enumerable: true,
        configurable: true
    });
    TaskManager.prototype.getQueue = function (taskType, bindQueueToExchange) {
        var _this = this;
        if (queues[taskType])
            return queues[taskType];
        return this.getChannel().then(function () {
            var queueName = QUEUE_PREFIX + taskType;
            queues[taskType] = _this.assertQueue(queueName);
            if (bindQueueToExchange)
                _this.bindQueue(taskType);
            return queues[taskType];
        });
    };
    TaskManager.prototype.assertExchange = function () {
        var _this = this;
        return this.getChannel().then(function (channel) {
            var exchangeName = EXCHANGE_PREFIX + _this.service;
            if (_this.exchangeName == exchangeName)
                return Promise.resolve(channel);
            return new Promise(function (resolve, reject) {
                channel.assertExchange(exchangeName, 'direct', EXCHANGE_OPTIONS, function (err) {
                    _this.exchangeName = exchangeName;
                    if (err)
                        return reject(err);
                    resolve(channel);
                });
            });
        });
    };
    TaskManager.prototype.assertQueue = function (queueName) {
        return this.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                channel.assertQueue(queueName, JOB_QUEUE_OPTIONS, function (err, ok) {
                    if (err)
                        return reject(err);
                    resolve(ok);
                });
            });
        });
    };
    TaskManager.prototype.bindQueue = function (taskType) {
        var _this = this;
        return this.getChannel().then(function (channel) {
            var queueName = QUEUE_PREFIX + taskType;
            channel.bindQueue(queueName, _this.exchangeName, taskType);
        });
    };
    TaskManager.prototype.purgeQueue = function (taskType, cb) {
        return this.getChannel().then(function (channel) {
            var queueName = QUEUE_PREFIX + taskType;
            return new Promise(function (resolve, reject) {
                channel.checkQueue(queueName, function (err, ok) {
                    if (err)
                        return resolve(null);
                    if (ok) {
                        return channel.purgeQueue(queueName, function (err, reply) {
                            if (err)
                                return reject(err);
                            resolve(reply);
                        });
                    }
                    resolve(null);
                });
            });
        }).nodeify(cb);
    };
    TaskManager.prototype.processTask = function (taskType, taskCallback) {
        var _this = this;
        var queueName = QUEUE_PREFIX + taskType, currentChannel;
        return this.getChannel().then(function (channel) {
            currentChannel = channel;
            return _this.getQueue(taskType);
        }).then(function () {
            currentChannel.prefetch(1);
            currentChannel.consume(queueName, function (msg) {
                var taskData = JSON.parse(msg.content.toString());
                taskCallback(taskData, function () {
                    currentChannel.ack(msg);
                });
            }, { noAck: false });
        });
    };
    return TaskManager;
})();
var taskManager = new TaskManager();
module.exports = taskManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza01hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdGFza01hbmFnZXIudHMiXSwibmFtZXMiOlsiVGFzayIsIlRhc2suY29uc3RydWN0b3IiLCJUYXNrLmdldENoYW5uZWwiLCJUYXNrLnN0YXJ0IiwiVGFza01hbmFnZXIiLCJUYXNrTWFuYWdlci5jb25zdHJ1Y3RvciIsIlRhc2tNYW5hZ2VyLmNyZWF0ZVRhc2siLCJUYXNrTWFuYWdlci5nZXRDaGFubmVsIiwiVGFza01hbmFnZXIuY2hhbm5lbE1hbmFnZXIiLCJUYXNrTWFuYWdlci5nZXRRdWV1ZSIsIlRhc2tNYW5hZ2VyLmFzc2VydEV4Y2hhbmdlIiwiVGFza01hbmFnZXIuYXNzZXJ0UXVldWUiLCJUYXNrTWFuYWdlci5iaW5kUXVldWUiLCJUYXNrTWFuYWdlci5wdXJnZVF1ZXVlIiwiVGFza01hbmFnZXIucHJvY2Vzc1Rhc2siXSwibWFwcGluZ3MiOiJBQUFBLDRDQUE0QztBQUc1QyxJQUFPLFdBQVcsV0FBVyxJQUFJLENBQUMsQ0FBQztBQUVuQyxJQUFNLGVBQWUsR0FBRyxjQUFjLENBQUM7QUFDdkMsSUFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUM7QUFDMUMsSUFBTSxnQkFBZ0IsR0FBRyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBQyxDQUFDO0FBQzVELElBQU0saUJBQWlCLEdBQUcsRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUMsQ0FBQztBQUU3RCxJQUFPLE9BQU8sV0FBVyxVQUFVLENBQUMsQ0FBQTtBQUNwQyxJQUFPLElBQUksV0FBVyxXQUFXLENBQUMsQ0FBQTtBQUNsQyxJQUFPLENBQUMsV0FBVyxRQUFRLENBQUMsQ0FBQTtBQU81QixJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFFaEI7SUFNRUEsY0FBWUEsSUFBV0EsRUFBRUEsTUFBaUJBO1FBQ3hDQyxJQUFJQSxDQUFDQSxJQUFJQSxH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