/// <reference path="../typings/tsd.d.ts" />
var async = require("async");
var QUEUE_PREFIX = "_queue_rpc:";
var CALL_TIMEOUT = 3600 * 1000;
var returnCbs = {}, replyQueue = "", channel = null, DEBUG = false;
function dbg() {
    if (DEBUG) {
        var args = [].slice.call(arguments);
        console.log.apply(console, args);
    }
}
function randomString(string_length) {
    var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
    string_length = string_length || 48;
    var randomstring = '';
    for (var i = 0; i < string_length; i++) {
        var rnum = Math.floor(Math.random() * chars.length);
        randomstring += chars.substring(rnum, rnum + 1);
    }
    return randomstring;
}
setInterval(function () {
    var removeKeys = [], now = new Date().getTime(), k, timeCreated, data;
    for (k in returnCbs) {
        timeCreated = returnCbs[k].date.getTime();
        if (now - timeCreated >= CALL_TIMEOUT) {
            removeKeys.push(k);
        }
    }
    removeKeys.forEach(function (k) {
        data = returnCbs[k];
        delete returnCbs[k];
    });
}, 3600 * 1000);
function _parseAction(event) {
    return {
        queue: QUEUE_PREFIX + event,
    };
}
function _errorPrepare(err) {
    if (!err) {
        return null;
    }
    return {
        code: err.code ? err.code : -1,
        msg: err.message,
        data: err.data,
        errtype: err.errtype
    };
}
var RPC = function () {
    this.processors = {};
};
RPC.prototype._createQueue = function (action, cb) {
    var actionParsed = _parseAction(action);
    var self = this;
    channel.assertQueue(actionParsed.queue, {}, function (err, attrs) {
        if (err) {
            return cb(err);
        }
        channel.consume(actionParsed.queue, function (msg) {
            var content = JSON.parse(msg.content);
            try {
                dbg("Incoming RPC request", action);
                self.processors[action].listener(content, function (err, body) {
                    var response = {
                        error: _errorPrepare(err),
                        body: typeof body !== "undefined" ? body : null
                    };
                    channel.sendToQueue(msg.properties.replyTo, new Buffer(JSON.stringify(response)), {
                        correlationId: msg.properties.correlationId
                    });
                    dbg("Incoming RPC request", action, " processed! reply to", msg.properties.replyTo);
                });
            }
            catch (ex) {
                console.error("ERROR IN rpc processor\n", ex.message, ex.stack);
            }
            channel.ack(msg);
        }, {}, function (err, res) {
            console.log(err, res);
            cb(err, res.consumerTag);
        });
    });
};
RPC.prototype.register = function (action, cb, regiterCb) {
    var self = this;
    regiterCb = regiterCb || function () { };
    if (self.processors[action]) {
        throw new Error("Can't register same action processor twice");
    }
    var consumerTag;
    async.series([
        function (next) {
            module.exports._connect(function () {
                next();
            });
        },
        function (next) {
            self._createQueue(action, function (err, tag) {
                if (!err) {
                    consumerTag = tag;
                }
                next(err);
            });
        }
    ], function (err) {
        if (!err) {
            self.processors[action] = {
                listener: cb,
                consumerTag: consumerTag
            };
        }
        regiterCb(err);
    });
    return true;
};
RPC.prototype.unregister = function (action, unregisterCb) {
    unregisterCb = unregisterCb || function () { };
    var self = this;
    if (!self.processors[action]) {
        process.nextTick(function () {
            unregisterCb(null);
        });
        return false;
    }
    channel.cancel(self.processors[action].consumerTag, function (err) {
        if (!err) {
            delete self.processors[action];
        }
        unregisterCb(err);
    });
};
RPC.prototype.call = function (action, params, cb) {
    if (typeof params === "function") {
        cb = params;
        params = {};
    }
    var actionParsed = _parseAction(action);
    async.series([
        function (next) {
            module.exports._connect(function () {
                next();
            });
        },
        function (next) {
            if (replyQueue) {
                return next();
            }
            channel.assertQueue("", {
                durable: false,
                autoDelete: true
            }, function (err, attrs) {
                if (err) {
                    return cb(err);
                }
                replyQueue = attrs.queue;
                channel.consume(replyQueue, function (_msg) {
                    var msg = JSON.parse(_msg.content), correlationId = _msg.properties.correlationId;
                    if (returnCbs[correlationId]) {
                        dbg("RPC Response", returnCbs[correlationId].action);
                        var resError = null;
                        if (msg.error) {
                            resError = new Error(msg.error.msg);
                            resError.code = msg.error.code;
                            resError.errtype = msg.error.errtype;
                            resError.data = msg.error.data;
                        }
                        var returnCb = returnCbs[correlationId].cb;
                        delete returnCbs[correlationId];
                        returnCb(resError, msg.body);
                    }
                    else {
                        dbg("Obtained reply but unrecognized by correlationId:", correlationId);
                    }
                    channel.ack(_msg);
                });
                next();
            });
        },
        function () {
            var correlationId = randomString();
            dbg("RPC Call", action, "wait reply to", replyQueue);
            returnCbs[correlationId] = {
                date: new Date(),
                cb: cb,
                action: action,
                params: params
            };
            channel.sendToQueue(actionParsed.queue, new Buffer(JSON.stringify(params)), {
                correlationId: correlationId,
                replyTo: replyQueue
            });
        }
    ]);
};
RPC.purgeActionQueue = function (action, cb) {
    var actionParsed = _parseAction(action);
    channel.purgeQueue(actionParsed.queue, cb);
};
RPC.setChannel = function (_channel) {
    channel = _channel;
};
module.exports = RPC;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnBjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3JwYy50cyJdLCJuYW1lcyI6WyJkYmciLCJyYW5kb21TdHJpbmciLCJfcGFyc2VBY3Rpb24iLCJfZXJyb3JQcmVwYXJlIl0sIm1hcHBpbmdzIjoiQUFBQSw0Q0FBNEM7QUFHNUMsSUFBTyxLQUFLLFdBQVcsT0FBTyxDQUFDLENBQUE7QUFHL0IsSUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDO0FBQ25DLElBQU0sWUFBWSxHQUFHLElBQUksR0FBRyxJQUFJLENBQUM7QUFFakMsSUFBSSxTQUFTLEdBQUcsRUFBRSxFQUNoQixVQUFVLEdBQUcsRUFBRSxFQUNmLE9BQU8sR0FBRyxJQUFJLEVBQ2QsS0FBSyxHQUFHLEtBQUssQ0FBQztBQUVoQjtJQUNFQSxFQUFFQSxDQUFBQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNUQSxJQUFJQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtRQUNwQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDbkNBLENBQUNBO0FBQ0hBLENBQUNBO0FBRUQsc0JBQXNCLGFBQWE7SUFDakNDLElBQUlBLEtBQUtBLEdBQUdBLCtEQUErREEsQ0FBQ0E7SUFDNUVBLGFBQWFBLEdBQUdBLGFBQWFBLElBQUlBLEVBQUVBLENBQUNBO0lBQ3BDQSxJQUFJQSxZQUFZQSxHQUFHQSxFQUFFQSxDQUFDQTtJQUV0QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBQ0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBQ0EsYUFBYUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7UUFDbkNBLElBQUlBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1B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