/// <reference path="../typings/tsd.d.ts" />
var EXCHANGE_PREFIX = "nimbus:jobs:";
var QUEUE_PREFIX = "nimbus:jobs:queue:";
var EXCHANGE_OPTIONS = { durable: true, autoDelete: false };
var JOB_QUEUE_OPTIONS = { durable: true, autoDelete: false };
var Promise = require("bluebird");
var uuid = require("node-uuid");
var _ = require("lodash");
var queues = {};
var Task = (function () {
    function Task(type, params) {
        this.uuid = uuid.v4();
        this.type = type;
        this.params = params;
    }
    Task.prototype.start = function (done) {
        var _this = this;
        var currentChannel;
        var params = _.clone(this.params);
        params['uuid'] = this.uuid;
        var eventData = new Buffer(JSON.stringify(params));
        this.taskManager.getChannel().then(function (channel) {
            currentChannel = channel;
            return taskManager.assertExchange();
        }).then(function () {
            return taskManager.getQueue(_this.type, true);
        }).then(function () {
            currentChannel.publish(_this.taskManager.exchangeName, _this.type, eventData);
            if (done)
                done();
        });
        return this;
    };
    return Task;
})();
var taskManager = {
    service: "unknown",
    exchangeName: "",
    channelPromise: null,
    channelManager: null,
    getChannel: function () {
        if (!taskManager.channelPromise) {
            taskManager.channelPromise = new Promise(function (resolve, reject) {
                taskManager.channelManager.connect(function (err, channel) {
                    resolve(channel);
                });
            });
        }
        return taskManager.channelPromise;
    },
    getQueue: function (taskType, bindQueueToExchange) {
        if (queues[taskType])
            return queues[taskType];
        return taskManager.getChannel().then(function () {
            var queueName = QUEUE_PREFIX + taskType;
            queues[taskType] = taskManager.assertQueue(queueName);
            if (bindQueueToExchange)
                taskManager.bindQueue(taskType);
            return queues[taskType];
        });
    },
    assertExchange: function () {
        return taskManager.getChannel().then(function (channel) {
            var exchangeName = EXCHANGE_PREFIX + taskManager.service;
            if (taskManager.exchangeName == exchangeName)
                return Promise.resolve(channel);
            return new Promise(function (resolve, reject) {
                channel.assertExchange(exchangeName, 'direct', EXCHANGE_OPTIONS, function (err) {
                    taskManager.exchangeName = exchangeName;
                    if (err)
                        return reject(err);
                    resolve(channel);
                });
            });
        });
    },
    assertQueue: function (queueName) {
        return taskManager.getChannel().then(function (channel) {
            return new Promise(function (resolve, reject) {
                channel.assertQueue(queueName, JOB_QUEUE_OPTIONS, function (err, ok) {
                    if (err)
                        return reject(err);
                    resolve(ok);
                });
            });
        });
    },
    bindQueue: function (taskType) {
        return taskManager.getChannel().then(function (channel) {
            var queueName = QUEUE_PREFIX + taskType;
            channel.bindQueue(queueName, taskManager.exchangeName, taskType);
        });
    },
    purgeQueue: function (taskType, cb) {
        return taskManager.getChannel().then(function (channel) {
            var queueName = QUEUE_PREFIX + taskType;
            return channel.purgeQueue(queueName, cb);
        });
    },
    Task: Task,
    processTask: function (taskType, taskCallback) {
        var queueName = QUEUE_PREFIX + taskType, currentChannel;
        return taskManager.getChannel().then(function (channel) {
            currentChannel = channel;
            return taskManager.getQueue(taskType);
        }).then(function () {
            currentChannel.prefetch(1);
            currentChannel.consume(queueName, function (msg) {
                var taskData = JSON.parse(msg.content.toString());
                taskCallback(taskData, function () {
                    currentChannel.ack(msg);
                });
            }, { noAck: false });
        });
    }
};
Task.prototype.taskManager = taskManager;
module.exports = taskManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90YXNrLnRzIl0sIm5hbWVzIjpbIlRhc2siLCJUYXNrLmNvbnN0cnVjdG9yIiwiVGFzay5zdGFydCJdLCJtYXBwaW5ncyI6IkFBQUEsNENBQTRDO0FBRTVDLElBQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQztBQUN2QyxJQUFNLFlBQVksR0FBRyxvQkFBb0IsQ0FBQztBQUMxQyxJQUFNLGdCQUFnQixHQUFHLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLENBQUM7QUFDOUQsSUFBTSxpQkFBaUIsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBRy9ELElBQU8sT0FBTyxXQUFXLFVBQVUsQ0FBQyxDQUFBO0FBQ3BDLElBQU8sSUFBSSxXQUFXLFdBQVcsQ0FBQyxDQUFBO0FBQ2xDLElBQU8sQ0FBQyxXQUFXLFFBQVEsQ0FBQyxDQUFBO0FBTzVCLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUVoQjtJQU1FQSxjQUFhQSxJQUFZQSxFQUFFQSxNQUFrQkE7UUFDM0NDLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1FBQ3RCQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUNqQkEsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7SUFDdkJBLENBQUNBO0lBQ0RELG9CQUFLQSxHQUFMQSxVQUFNQSxJQUFLQTtRQUFYRSxpQkFpQkNBO1FBaEJDQSxJQUFJQSxjQUFjQSxDQUFDQTtRQUNuQkEsSUFBSUEsTUFBTUEsR0FBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDakNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENB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